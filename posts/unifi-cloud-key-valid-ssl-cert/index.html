<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Setting up a Unifi Cloud Key with a valid SSL cert" /><meta property="og:locale" content="en_US" /><meta name="description" content="So I recently moved from a self-hosted unifi controller to a unifi cloud key gen2. https://eu.store.ui.com/collections/unifi-accessories-cloud-key/products/unifi-cloud-key-gen2 I wanted to be able to access it locally though over https with a valid cert. It turns out the cloudkey just runs a basic debian strech install with standard apt commands! So heres how I made that happpen." /><meta property="og:description" content="So I recently moved from a self-hosted unifi controller to a unifi cloud key gen2. https://eu.store.ui.com/collections/unifi-accessories-cloud-key/products/unifi-cloud-key-gen2 I wanted to be able to access it locally though over https with a valid cert. It turns out the cloudkey just runs a basic debian strech install with standard apt commands! So heres how I made that happpen." /><link rel="canonical" href="http://jam.ie/posts/unifi-cloud-key-valid-ssl-cert/" /><meta property="og:url" content="http://jam.ie/posts/unifi-cloud-key-valid-ssl-cert/" /><meta property="og:site_name" content="ITJamie - ramblings and stuff" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-20T21:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Setting up a Unifi Cloud Key with a valid SSL cert" /><meta name="twitter:site" content="@JamieIT" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"So I recently moved from a self-hosted unifi controller to a unifi cloud key gen2. https://eu.store.ui.com/collections/unifi-accessories-cloud-key/products/unifi-cloud-key-gen2 I wanted to be able to access it locally though over https with a valid cert. It turns out the cloudkey just runs a basic debian strech install with standard apt commands! So heres how I made that happpen.","headline":"Setting up a Unifi Cloud Key with a valid SSL cert","dateModified":"2021-06-20T21:00:00+01:00","datePublished":"2021-06-20T21:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://jam.ie/posts/unifi-cloud-key-valid-ssl-cert/"},"url":"http://jam.ie/posts/unifi-cloud-key-valid-ssl-cert/","@type":"BlogPosting","@context":"https://schema.org"}</script><title>Setting up a Unifi Cloud Key with a valid SSL cert | ITJamie - ramblings and stuff</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ITJamie - ramblings and stuff"><meta name="application-name" content="ITJamie - ramblings and stuff"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://en.gravatar.com/userimage/937509/b52977de0f1ad47561e62cafed301e3e.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ITJamie - ramblings and stuff</a></div><div class="site-subtitle font-italic">Random tech and thoughts...</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ITJamie" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/JamieIT" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['jamie','itjamie.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Setting up a Unifi Cloud Key with a valid SSL cert</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Setting up a Unifi Cloud Key with a valid SSL cert</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Jamie Murphy </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Jun 20, 2021, 9:00 PM +0100" prep="on" > Jun 20 <i class="unloaded">2021-06-20T21:00:00+01:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="306 words">1 min</span></div></div><div class="post-content"><p>So I recently moved from a self-hosted unifi controller to a unifi cloud key gen2. https://eu.store.ui.com/collections/unifi-accessories-cloud-key/products/unifi-cloud-key-gen2 I wanted to be able to access it locally though over https with a valid cert. It turns out the cloudkey just runs a basic debian strech install with standard apt commands! So heres how I made that happpen.</p><p>Pre-requisites:</p><ul><li>unifi cloud key<li>A domain with cloudflare DNS setup &amp; API keys setup</ul><p>First steps.</p><ul><li>Make sure the Cloud Key is upto date.<li>Enable SSH on the cloud key.<li>A subdomain setup with an A record of your local cloud key IP<li>Open an SSH session to the cloudkey. “root” is the username plus the password you setup in the cloudkey gui</ul><p>Install certbot with cloudflare dns extension</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">apt update
apt <span class="nb">install </span>python3-certbot-dns-cloudflare</code></pre></figure><p>Create secrets dirs</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">mkdir</span> ~/.secrets/
<span class="nb">mkdir</span> ~/.secrets/certbot</code></pre></figure><p>Create secrets file with your cloudflare api keys</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">vi ~/.secrets/certbot/cloudflare.ini</code></pre></figure><p>Example Content</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre># Cloudflare API credentials used by Certbot
dns_cloudflare_email = you@example.com
dns_cloudflare_api_key = wen_lambo?wen_moon?
</pre></table></code></div></div><p>Secure permissions on cloudflare creds (stops warnings in certbot output)</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">chmod </span>600 ~/.secrets/certbot/cloudflare.ini</code></pre></figure><p>Time to request the cert!</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash">certbot certonly   <span class="nt">--dns-cloudflare</span>   <span class="nt">--dns-cloudflare-credentials</span> ~/.secrets/certbot/cloudflare.ini <span class="nt">-d</span> fqdn_of_your_cloudkey.example.com</code></pre></figure><p>Assuming that went well (read the output and debug if needed) move ahead to configure the cloudkey to use the key. Note the path of the cert and key from certbots output</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">cd</span> /data/unifi-core/config/
<span class="nb">cp </span>unifi-core.crt unifi-core.crt.bk
<span class="nb">cp </span>unifi-core.key unifi-core.key.bk
<span class="nb">rm </span>unifi-core.crt
<span class="nb">rm </span>unifi-core.key
<span class="nb">ln</span> <span class="nt">-s</span> /etc/letsencrypt/live/fqdn_of_your_cloudkey.example.com/cert.pem unifi-core.crt <span class="c"># Your paths will be slightly different depending on your domain</span>
<span class="nb">ln</span> <span class="nt">-s</span> /etc/letsencrypt/live/fqdn_of_your_cloudkey.example.com/privkey.pem unifi-core.key <span class="c"># Your paths will be slightly different depending on your domain</span>
service unifi-core restart</code></pre></figure><p>Add the following to your root user crontab file (use <code class="language-plaintext highlighter-rouge">crontab -e</code>)</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>41 2 * * * certbot renew --post-hook "service unifi-core restart"
</pre></table></code></div></div><p>Now you should be able to access your cloudkey locally via <code class="language-plaintext highlighter-rouge">fqdn_of_your_cloudkey.example.com</code> with a valid cert!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/unifi/'>unifi</a>, <a href='/categories/debian/'>debian</a>, <a href='/categories/cloudflare/'>cloudflare</a>, <a href='/categories/certbot/'>certbot</a>, <a href='/categories/ssl/'>ssl</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Setting up a Unifi Cloud Key with a valid SSL cert - ITJamie - ramblings and stuff&url=http://jam.ie/posts/unifi-cloud-key-valid-ssl-cert/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Setting up a Unifi Cloud Key with a valid SSL cert - ITJamie - ramblings and stuff&u=http://jam.ie/posts/unifi-cloud-key-valid-ssl-cert/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=http://jam.ie/posts/unifi-cloud-key-valid-ssl-cert/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/JamieIT">Jamie Murphy</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://jam.ie{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
